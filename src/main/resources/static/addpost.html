<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>发布新帖子</title>
    <!-- 引入Element UI样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css">
    <style>
        /* 基础和布局样式 */
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
        }

        #app {
            max-width: 900px;
            margin: 40px auto;
            padding: 24px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .form-container {
            display: flex;
            gap: 20px;
        }

        /* 左侧：图片上传区域 */
        .image-uploader {
            flex-basis: 300px;
            flex-shrink: 0;
            height: 400px;
            border: 2px dashed #d9d9d9;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.3s;
            overflow: hidden;
        }

        .image-uploader:hover {
            border-color: #1890ff;
        }

        .uploader-placeholder {
            text-align: center;
            color: #888;
        }

        .plus-icon {
            font-size: 48px;
            color: #d9d9d9;
            margin-bottom: 8px;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 右侧：表单字段 */
        .form-fields {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-item {
            margin-bottom: 16px;
        }

        .submit-area {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
<div id="app">
    <el-form ref="form" :model="postForm" label-width="80px" class="form-container">
        <!-- 左侧图片上传区 -->
        <div class="image-uploader" @click="triggerUpload">
            <div v-if="!fileUrl" class="uploader-placeholder">
                <div class="plus-icon">+</div>
                <p>点击上传图片</p>
                <p style="font-size: 12px;">支持JPG/PNG，不超过5MB</p>
            </div>
            <div v-else class="image-preview">
                <img :src="fileUrl" alt="预览图">
            </div>
            <input
                    type="file"
                    ref="fileInput"
                    style="display: none"
                    accept="image/jpeg,image/png"
                    @change="handleFileChange">
        </div>

        <!-- 右侧表单区 -->
        <div class="form-fields">
            <!-- 标题输入 -->
            <el-form-item label="标题" prop="title" :rules="[{ required: true, message: '请输入标题', trigger: 'blur' }]">
                <el-input
                        v-model="postForm.title"
                        placeholder="请输入帖子标题"
                        maxlength="100"
                        show-word-limit>
                </el-input>
            </el-form-item>

            <!-- 板块选择 -->
            <el-form-item label="板块" prop="plateId">
                <el-select v-model="postForm.plateId" placeholder="请选择板块">
                    <el-option
                            v-for="plate in availablePlates"
                            :key="plate.plateId"
                            :label="plate.name"
                            :value="plate.plateId">
                    </el-option>
                </el-select>
            </el-form-item>

            <!-- 内容输入 -->
            <el-form-item label="内容" prop="content" :rules="[{ required: true, message: '请输入内容', trigger: 'blur' }]">
                <el-input
                        type="textarea"
                        v-model="postForm.content"
                        placeholder="请输入帖子内容"
                        :rows="10"
                        maxlength="2000"
                        show-word-limit>
                </el-input>
            </el-form-item>

            <!-- 提交按钮区域 -->
            <div class="submit-area">
                <el-button type="primary" @click="submitForm">发布帖子</el-button>
                <el-button @click="cancel">取消</el-button>
            </div>
        </div>
    </el-form>
</div>

<!-- 引入依赖脚本 -->
<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    // Axios 配置
    axios.defaults.baseURL = 'http://localhost:8080';
    axios.defaults.withCredentials = true;

    // 请求拦截器添加token
    axios.interceptors.request.use(
        config => {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        },
        error => Promise.reject(error)
    );

    new Vue({
        el: '#app',
        data() {
            return {
                postForm: {
                    title: '',       // 帖子标题
                    content: '',     // 帖子内容
                    plateId: null    // 板块ID
                },
                fileUrl: '',       // 图片预览地址
                selectedFile: null, // 选中的文件
                availablePlates: [] // 板块列表
            };
        },
        created() {
            // 页面加载时获取板块列表
            this.fetchPlates();
        },
        methods: {
            // 获取板块列表
            async fetchPlates() {
                try {
                    const response = await axios.get('/plate/select');
                    if (response.data.code === 200 && response.data.data) {
                        this.availablePlates = response.data.data;
                        // 默认选中第一个板块
                        if (this.availablePlates.length > 0) {
                            this.postForm.plateId = this.availablePlates[0].plateId;
                        }
                    }
                } catch (error) {
                    console.error('获取板块失败:', error);
                    this.$message.error('加载板块失败，请刷新页面重试');
                }
            },

            // 触发文件选择
            triggerUpload() {
                this.$refs.fileInput.click();
            },

            // 处理文件选择
            handleFileChange(event) {
                const file = event.target.files[0];
                if (!file) return;

                // 验证文件类型和大小
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    this.$message.error('请上传JPG或PNG格式的图片');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    this.$message.error('图片大小不能超过5MB');
                    return;
                }

                // 保存文件并生成预览
                this.selectedFile = file;
                this.fileUrl = URL.createObjectURL(file);

                // 清空input值，允许重复选择同一文件
                event.target.value = '';
            },

            // 提交表单
            async submitForm() {
                // 表单验证
                this.$refs.form.validate(async (valid) => {
                    if (!valid) return;

                    try {
                        const formData = new FormData();
                        formData.append('title', this.postForm.title);
                        formData.append('content', this.postForm.content);
                        formData.append('plateId', this.postForm.plateId);

                        // 添加图片（可选）
                        if (this.selectedFile) {
                            formData.append('file', this.selectedFile);
                        }

                        // 发送请求
                        const response = await axios.post('/post/add', formData);

                        if (response.data.code === 200) {
                            this.$message({
                                type: 'success',
                                message: '发布成功！正在跳转...',
                                duration: 2000
                            });

                            // 2秒后跳转到帖子列表页
                            setTimeout(() => {
                                window.location.href = '/post/list'; // 替换为实际的帖子列表页面
                            }, 2000);
                        } else {
                            this.$message.error('发布失败: ' + (response.data.message || '未知错误'));
                        }
                    } catch (error) {
                        console.error('发布请求失败:', error);
                        this.$message.error('网络错误，请稍后重试');
                    }
                });
            },

            // 取消发布
            cancel() {
                if (confirm('确定要取消发布吗？所有内容将被清空。')) {
                    this.resetForm();
                    // 返回上一页或跳转到首页
                    window.history.back();
                }
            },

            // 重置表单
            resetForm() {
                this.postForm = {
                    title: '',
                    content: '',
                    plateId: this.availablePlates.length > 0 ? this.availablePlates[0].plateId : null
                };
                this.selectedFile = null;
                this.fileUrl = '';
                this.$refs.form.resetFields();
            }
        }
    });
</script>
</body>
</html>