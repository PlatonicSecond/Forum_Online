<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¸–å­è¯¦æƒ…</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        /* å¸–å­è¯¦æƒ…æ ·å¼ */
        .comments-section h2 {
            margin-bottom: 15px;
        }
        #comment-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            resize: vertical;
            font-size: 14px;
        }
        #comment-form button {
            display: block;
            margin-top: 10px;
            margin-left: auto;
            padding: 10px 25px;
            border: none;
            background-color: #ffd800; /* Yellow button like in the main page */
            color: #000;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #comment-form button:hover {
            background-color: #fde946;
        }
        #comments-list {
            margin-top: 20px;
        }
        .comment-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-author {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .comment-content {
            margin-bottom: 8px;
        }
        .comment-time {
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>

<div class="post-layout">
    <!-- LEFT COLUMN: IMAGE -->
    <div class="left-column">
        <div id="image-loading" class="image-loading">æ­£åœ¨åŠ è½½å›¾ç‰‡...</div>
        <img id="post-image" style="display: none;" alt="å¸–å­å›¾ç‰‡">
    </div>

    <!-- RIGHT COLUMN: CONTENT & COMMENTS -->
    <div class="right-column">
        <!-- Container for post details -->
        <div id="post-details">
            <div class="post-info">
                <h1 id="post-title"></h1>
                <div class="post-meta">
                    <span id="post-user"></span>
                    <span id="post-time"></span>
                    <span id="post-views"></span>
                </div>
                <div id="post-body" class="post-body"></div>
            </div>

            <!-- Container for comments -->
            <div class="comments-section">
                <h2>è¯„è®ºåŒº</h2>
                <form id="comment-form">
                    <textarea id="comment-content" required placeholder="è¯·å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                    <button type="submit" id="submit-comment-btn">å‘å¸ƒ</button>
                </form>
                <div id="comments-list">
                    <!-- Comments will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // è·å–å¸–å­IDï¼ˆä»URLå‚æ•°ä¸­æå–ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        if (!postId) {
            alert("æ— æ•ˆçš„å¸–å­ID");
            return;
        }

        // è·å–å½“å‰ç”¨æˆ·IDï¼ˆå‡è®¾é€šè¿‡APIæˆ–å‰ç«¯å­˜å‚¨ï¼‰
        let currentUserId = null;

        // è·å–å¸–å­è¯¦æƒ…
        async function fetchPostDetails() {
            try {
                const response = await axios.get('/post/select', { params: { id: postId } });
                const post = response.data[0]; // å‡è®¾è¿”å›çš„æ˜¯æ•°ç»„

                if (!post || !post.postId) throw new Error('æœªæ‰¾åˆ°è¯¥å¸–å­');

                // æ¸²æŸ“å¸–å­è¯¦æƒ…
                document.getElementById('post-title').textContent = post.title;
                document.getElementById('post-user').textContent = `ğŸ‘¤ ä½œè€…ID: ${post.authorId}`;
                document.getElementById('post-time').textContent = `ğŸ•’ å‘å¸ƒäº: ${formatDateTime(post.createTime)}`;
                document.getElementById('post-body').innerHTML = post.content;

                // æ¸²æŸ“å›¾ç‰‡
                const postImageEl = document.getElementById('post-image');
                if (post.imgPath) {
                    postImageEl.src = '/images/' + post.imgPath;
                    postImageEl.style.display = 'block';
                }
                document.getElementById('image-loading').style.display = 'none';

            } catch (error) {
                alert('åŠ è½½å¸–å­å¤±è´¥');
                console.error('åŠ è½½å¸–å­è¯¦æƒ…å¤±è´¥', error);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString();
        }

        // æäº¤è¯„è®º
        async function handleCommentSubmit(event) {
            event.preventDefault();
            const content = document.getElementById('comment-content').value.trim();

            if (!content) {
                alert("è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼");
                return;
            }

            try {
                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿç™»å½•çŠ¶æ€ï¼‰
                currentUserId = 1; // åº”æ›¿æ¢ä¸ºçœŸå®çš„ç”¨æˆ·ID

                const payload = {
                    content: content,
                    authorId: currentUserId,
                    postId: parseInt(postId)
                };

                // å‘é€POSTè¯·æ±‚
                await axios.post('/comments', payload);

                // æˆåŠŸååˆ·æ–°è¯„è®ºåˆ—è¡¨
                fetchAndRenderComments();

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('comment-content').value = '';
            } catch (error) {
                alert("è¯„è®ºæäº¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                console.error('å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
            }
        }

        // è·å–å¹¶æ¸²æŸ“è¯„è®º
        async function fetchAndRenderComments() {
            try {
                const response = await axios.get('/comments/post/' + postId);
                const comments = response.data;

                const commentsListEl = document.getElementById('comments-list');
                commentsListEl.innerHTML = '';

                if (comments.length === 0) {
                    commentsListEl.innerHTML = '<p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢å æ²™å‘å§ï¼</p>';
                    return;
                }

                comments.forEach(comment => {
                    const item = document.createElement('div');
                    item.className = 'comment-item';
                    item.innerHTML = `
                        <div class="comment-author">ç”¨æˆ·ID: ${comment.authorId}</div>
                        <div class="comment-content">${comment.content}</div>
                        <div class="comment-time">${formatDateTime(comment.createTime)}</div>
                    `;
                    commentsListEl.appendChild(item);
                });

            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥', error);
                document.getElementById('comments-list').innerHTML = '<p style="color: red;">è¯„è®ºåŠ è½½å¤±è´¥ã€‚</p>';
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            try {
                await fetchPostDetails(); // åŠ è½½å¸–å­è¯¦æƒ…
                await fetchAndRenderComments(); // åŠ è½½è¯„è®º

                // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶ç›‘å¬
                document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥', error);
            }
        }

        initializePage();
    });
</script>
</body>
</html>