<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>帖子详情</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        /* 帖子详情样式 */
        .comments-section h2 {
            margin-bottom: 15px;
        }
        #comment-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            resize: vertical;
            font-size: 14px;
        }
        #comment-form button {
            display: block;
            margin-top: 10px;
            margin-left: auto;
            padding: 10px 25px;
            border: none;
            background-color: #ffd800; /* Yellow button like in the main page */
            color: #000;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #comment-form button:hover {
            background-color: #fde946;
        }
        #comments-list {
            margin-top: 20px;
        }
        .comment-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-author {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .comment-content {
            margin-bottom: 8px;
        }
        .comment-time {
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>

<div class="post-layout">
    <!-- LEFT COLUMN: IMAGE -->
    <div class="left-column">
        <div id="image-loading" class="image-loading">正在加载图片...</div>
        <img id="post-image" style="display: none;" alt="帖子图片">
    </div>

    <!-- RIGHT COLUMN: CONTENT & COMMENTS -->
    <div class="right-column">
        <!-- Container for post details -->
        <div id="post-details">
            <div class="post-info">
                <h1 id="post-title"></h1>
                <div class="post-meta">
                    <span id="post-user"></span>
                    <span id="post-time"></span>
                    <span id="post-views"></span>
                </div>
                <div id="post-body" class="post-body"></div>
            </div>

            <!-- Container for comments -->
            <div class="comments-section">
                <h2>评论区</h2>
                <form id="comment-form">
                    <textarea id="comment-content" required placeholder="请写下你的评论..."></textarea>
                    <button type="submit" id="submit-comment-btn">发布</button>
                </form>
                <div id="comments-list">
                    <!-- Comments will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 获取帖子ID（从URL参数中提取）
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        if (!postId) {
            alert("无效的帖子ID");
            return;
        }

        // 获取当前用户ID（假设通过API或前端存储）
        let currentUserId = null;

        // 获取帖子详情
        async function fetchPostDetails() {
            try {
                const response = await axios.get('/post/select', { params: { id: postId } });
                const post = response.data[0]; // 假设返回的是数组

                if (!post || !post.postId) throw new Error('未找到该帖子');

                // 渲染帖子详情
                document.getElementById('post-title').textContent = post.title;
                document.getElementById('post-user').textContent = `👤 作者ID: ${post.authorId}`;
                document.getElementById('post-time').textContent = `🕒 发布于: ${formatDateTime(post.createTime)}`;
                document.getElementById('post-body').innerHTML = post.content;

                // 渲染图片
                const postImageEl = document.getElementById('post-image');
                if (post.imgPath) {
                    postImageEl.src = '/images/' + post.imgPath;
                    postImageEl.style.display = 'block';
                }
                document.getElementById('image-loading').style.display = 'none';

            } catch (error) {
                alert('加载帖子失败');
                console.error('加载帖子详情失败', error);
            }
        }

        // 格式化时间
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString();
        }

        // 提交评论
        async function handleCommentSubmit(event) {
            event.preventDefault();
            const content = document.getElementById('comment-content').value.trim();

            if (!content) {
                alert("请输入评论内容！");
                return;
            }

            try {
                // 获取当前用户信息（模拟登录状态）
                currentUserId = 1; // 应替换为真实的用户ID

                const payload = {
                    content: content,
                    authorId: currentUserId,
                    postId: parseInt(postId)
                };

                // 发送POST请求
                await axios.post('/comments', payload);

                // 成功后刷新评论列表
                fetchAndRenderComments();

                // 清空输入框
                document.getElementById('comment-content').value = '';
            } catch (error) {
                alert("评论提交失败，请重试");
                console.error('发布评论失败:', error);
            }
        }

        // 获取并渲染评论
        async function fetchAndRenderComments() {
            try {
                const response = await axios.get('/comments/post/' + postId);
                const comments = response.data;

                const commentsListEl = document.getElementById('comments-list');
                commentsListEl.innerHTML = '';

                if (comments.length === 0) {
                    commentsListEl.innerHTML = '<p>还没有评论，快来抢占沙发吧！</p>';
                    return;
                }

                comments.forEach(comment => {
                    const item = document.createElement('div');
                    item.className = 'comment-item';
                    item.innerHTML = `
                        <div class="comment-author">用户ID: ${comment.authorId}</div>
                        <div class="comment-content">${comment.content}</div>
                        <div class="comment-time">${formatDateTime(comment.createTime)}</div>
                    `;
                    commentsListEl.appendChild(item);
                });

            } catch (error) {
                console.error('加载评论失败', error);
                document.getElementById('comments-list').innerHTML = '<p style="color: red;">评论加载失败。</p>';
            }
        }

        // 初始化页面
        async function initializePage() {
            try {
                await fetchPostDetails(); // 加载帖子详情
                await fetchAndRenderComments(); // 加载评论

                // 添加表单提交事件监听
                document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);
            } catch (error) {
                console.error('初始化失败', error);
            }
        }

        initializePage();
    });
</script>
</body>
</html>